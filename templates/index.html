<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fruit Detection System</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #0f0f1e;
      color: #e0e0e0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }
    
    header h1 {
      margin: 0;
      font-size: 32px;
      font-weight: 600;
      color: #ffffff;
    }
    
    header p {
      margin: 10px 0 0;
      color: #ffffff;
      opacity: 0.95;
    }
    
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 30px;
      background: #1a1a2e;
      border-radius: 10px;
      padding: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      border: 1px solid #2d2d44;
    }
    
    .tab-button {
      flex: 1;
      padding: 15px 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: #b0b0c0;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .tab-button:hover {
      background: #252540;
      color: #ffffff;
    }
    
    .tab-button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: #1a1a2e;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      margin-bottom: 20px;
      border: 1px solid #2d2d44;
    }
    
    .card h2 {
      margin: 0 0 20px;
      font-size: 22px;
      color: #ffffff;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    
    .card h3 {
      margin: 20px 0 10px;
      font-size: 18px;
      color: #e0e0e0;
    }
    
    .upload-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    label {
      font-weight: 600;
      color: #e0e0e0;
      font-size: 14px;
    }
    
    input[type="file"] {
      padding: 12px;
      border: 2px dashed #4a4a6a;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      background: #252540;
      color: #e0e0e0;
    }
    
    input[type="file"]:hover {
      border-color: #667eea;
      background: #2d2d50;
    }
    
    select {
      padding: 12px;
      border: 1px solid #4a4a6a;
      border-radius: 8px;
      font-size: 14px;
      background: #252540;
      color: #e0e0e0;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }
    
    button[type="submit"] {
      padding: 14px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    button[type="submit"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .btn-clear {
      padding: 14px 24px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    .btn-clear:hover {
      background: #b91c1c;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.6);
    }
    
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .result-item {
      border: 1px solid #2d2d44;
      border-radius: 8px;
      overflow: hidden;
      background: #252540;
    }
    
    .result-item img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .result-info {
      padding: 15px;
      background: #1a1a2e;
    }
    
    .result-info h4 {
      margin: 0 0 10px;
      font-size: 16px;
      color: #ffffff;
    }

    .selected-detection-row {
      background: #33335a !important;
    }
    
    .detection-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .detection-table th,
    .detection-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #2d2d44;
    }
    
    .detection-table th {
      background: #252540;
      font-weight: 600;
      color: #ffffff;
      font-size: 13px;
      text-transform: uppercase;
    }
    
    .detection-table td {
      color: #e0e0e0;
    }
    
    .detection-table tr:hover {
      background: #252540;
    }
    
    .metrics-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .metrics-table th,
    .metrics-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #2d2d44;
    }
    
    .metrics-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
    }
    
    .metrics-table td {
      font-size: 14px;
      color: #e0e0e0;
    }
    
    .metrics-table tr:hover {
      background: #252540;
    }
    
    .best-metric {
      background: #1a4d2e !important;
      font-weight: 600;
      color: #4ade80;
    }
    
    .metric-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    
    .badge-success {
      background: #1a4d2e;
      color: #4ade80;
    }
    
    .badge-info {
      background: #1e3a5f;
      color: #60a5fa;
    }
    
    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .comparison-grid {
        grid-template-columns: 1fr;
      }
      
      .results-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .stat-box {
      padding: 15px;
      background: #252540;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    .stat-label {
      font-size: 12px;
      color: #b0b0c0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #ffffff;
      margin-top: 5px;
    }
    
    .hint {
      font-size: 13px;
      color: #b0b0c0;
      margin-top: 8px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #b0b0c0;
    }
    
    footer {
      text-align: center;
      padding: 30px 20px;
      color: #b0b0c0;
      font-size: 14px;
      margin-top: 40px;
    }
    
    details summary {
      color: #e0e0e0;
    }
    
    strong {
      color: #ffffff;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>üçé Fruit Detection System</h1>
    <p>Advanced Object Detection with Multiple Deep Learning Models</p>
  </header>

  <!-- Navigation Tabs -->
  <div class="tabs">
    <button class="tab-button active" onclick="switchTab(event, 'live-detection')">
      Live Detection
    </button>
    <button class="tab-button" onclick="switchTab(event, 'live-video')">
      Live Video
    </button>
    <button class="tab-button" onclick="switchTab(event, 'model-comparison')">
      Model Comparison
    </button>
    <button class="tab-button" onclick="switchTab(event, 'performance-metrics')">
      Performance Metrics
    </button>
  </div>

  <!-- Tab 1: Live Detection -->
  <div id="live-detection" class="tab-content active">
    <div class="card">
      <h2>Real-Time Object Detection</h2>
      <form id="live-detection-form" action="{{ url_for('live_detect') }}" method="post" enctype="multipart/form-data" class="upload-section">
        <div class="form-group">
          <label for="image">Upload Image</label>
          <input type="file" id="image" name="image" accept="image/*" {% if not (active_tab == 'live-detection' and uploaded_filename) %}required{% endif %}>
          {% if active_tab == 'live-detection' and uploaded_filename %}
          <input type="hidden" name="previous_file" value="{{ uploaded_basename }}">
          <input type="hidden" name="previous_filename" value="{{ uploaded_filename }}">
          <p class="hint" style="color: #4ade80; margin-top: 4px;">‚úì Current file: {{ uploaded_filename }}</p>
          {% else %}
          <p class="hint">Supported formats: JPG, JPEG, PNG</p>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label for="model">Select Detection Model</label>
          <select id="model" name="model" required>
            <option value="faster_rcnn" {% if selected_model == 'faster_rcnn' %}selected{% endif %}>Faster R-CNN</option>
            <option value="yolov8n" {% if selected_model == 'yolov8n' %}selected{% endif %}>YOLOv8 Nano</option>
            <option value="yolov8m" {% if selected_model == 'yolov8m' %}selected{% endif %}>YOLOv8 Medium</option>
            <option value="yolo11l" {% if selected_model == 'yolo11l' %}selected{% endif %}>YOLO11 Large</option>
          </select>
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button type="submit" style="flex: 1;">üöÄ Run Detection</button>
          <button type="button" onclick="clearForm('live-detection-form')" class="btn-clear" style="flex: 0 0 auto;">üóëÔ∏è Clear</button>
        </div>
      </form>
    </div>

    {% if live_result %}
    <div class="card">
      <h2>Detection Results - {{ live_result.model_name }}</h2>
      <div class="results-grid">
        <div class="result-item">
          <img src="{{ live_result.original_url }}" alt="Original">
          <div class="result-info">
            <h4>Original Image</h4>
          </div>
        </div>
          <div class="result-item">
            <!-- Container with overlay for drawing bounding boxes -->
            <div id="live-detection-container" style="position: relative; display: inline-block; width: 100%;">
              <img
                id="live-detection-image"
                src="{{ live_result.result_url }}"
                alt="Detection Result"
                style="width: 100%; height: auto; display: block;"
              >
              <!-- Transparent layer where JS will draw the highlight box -->
              <div
                id="live-bbox-layer"
                style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;"
              ></div>
            </div>

            <div class="result-info">
              <h4>Detection Output</h4>
              <div style="display: flex; gap: 15px; margin-top: 10px;">
                <div class="stat-box" style="flex: 1;">
                  <div class="stat-label">Detections</div>
                  <div class="stat-value">{{ live_result.detections|length }}</div>
                </div>
                <div class="stat-box" style="flex: 1;">
                  <div class="stat-label">Avg Confidence</div>
                  <div class="stat-value">{{ '%.1f%%' | format(live_result.avg_confidence * 100) }}</div>
                </div>
                <div class="stat-box" style="flex: 1;">
                  <div class="stat-label">Inference Time</div>
                  <div class="stat-value">{{ live_result.inference_time }}ms</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <h3>Detected Objects</h3>
      <table id="live-detections-table" class="detection-table">
        <thead>
          <tr>
            <th>Object</th>
            <th>Confidence</th>
            <th>Freshness</th>
            <th>Bounding Box</th>
          </tr>
        </thead>
        <tbody>
          {% for det in live_result.detections %}
          <tr
            class="live-detection-row"
            data-index="{{ loop.index0 }}"
            onclick="highlightLiveDetection({{ loop.index0 }})"
          >
            <td><strong>{{ det.label|capitalize }}</strong></td>
            <td>{{ '%.2f%%' | format(det.score * 100) }}</td>
            <td>
              {{ det.freshness|default('Unknown')|capitalize }}
              {% if det.freshness_score is defined %}
                ({{ '%.1f%%' | format(det.freshness_score * 100) }})
              {% endif %}
            </td>
            <td style="color: #b0b0c0; font-size: 16px;">
              [{{ '%.0f' | format(det.box[0]) }}, {{ '%.0f' | format(det.box[1]) }}, 
              {{ '%.0f' | format(det.box[2]) }}, {{ '%.0f' | format(det.box[3]) }}]
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>

  <!-- Tab 2: Live Video -->
  <div id="live-video" class="tab-content">
    <div class="card">
      <h2>Real-Time Webcam Detection</h2>
      <p style="color: #e0e0e0; margin-bottom: 20px;">
        Stream video from your webcam with live object detection. Select a model and click Start to begin.
      </p>
      
      <div style="background: #2d2d50; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <p style="color: #fbbf24; margin: 0; font-weight: 600;">‚ö†Ô∏è WSL Note:</p>
        <p style="color: #e0e0e0; margin: 5px 0 0 0; font-size: 14px;">
          If running on WSL (Windows Subsystem for Linux), webcam access may not work. 
          For best results, run the app directly on Windows or use the "Live Detection" tab with uploaded images.
        </p>
      </div>
      
      <div class="form-group" style="margin-bottom: 20px;">
        <label for="video-model">Select Detection Model</label>
        <select id="video-model" required>
          <option value="faster_rcnn">Faster R-CNN</option>
          <option value="yolov8n" selected>YOLOv8 Nano (Recommended for real-time)</option>
          <option value="yolov8m">YOLOv8 Medium</option>
          <option value="yolo11l">YOLO11 Large</option>
        </select>
      </div>
      
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button id="start-video-btn" onclick="startVideo()" style="flex: 1; padding: 14px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
          üìπ Start Video
        </button>
        <button id="stop-video-btn" onclick="stopVideo()" disabled style="flex: 1; padding: 14px 30px; background: #dc2626; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; opacity: 0.5;">
          ‚èπÔ∏è Stop Video
        </button>
      </div>
      
      <div id="video-container" style="display: none; margin-top: 20px;">
        <div style="background: #252540; padding: 20px; border-radius: 10px; border: 2px solid #667eea;">
          <h3 style="margin-top: 0; color: #ffffff;">Live Feed</h3>
          <img id="video-stream" src="" alt="Video Stream" style="width: 100%; max-width: 800px; border-radius: 8px; display: block; margin: 0 auto;">
          <p id="video-status" style="color: #4ade80; margin-top: 10px; text-align: center;">‚óè Live</p>
        </div>
      </div>
      
      <div id="video-placeholder" style="margin-top: 20px; padding: 60px 20px; background: #252540; border-radius: 10px; text-align: center; border: 2px dashed #4a4a6a;">
        <p style="color: #b0b0c0; font-size: 18px; margin: 0;">Select a model and click "Start Video" to begin</p>
        <p style="color: #b0b0c0; font-size: 14px; margin-top: 10px;">Make sure your webcam is connected and permissions are granted</p>
      </div>
    </div>
  </div>

  <!-- Tab 3: Model Comparison -->
  <div id="model-comparison" class="tab-content">
    <div class="card">
      <h2>Compare All Models Side-by-Side</h2>
      <form id="comparison-form" action="{{ url_for('compare_models') }}" method="post" enctype="multipart/form-data" class="upload-section">
        <div class="form-group">
          <label for="compare-image">Upload Image for Comparison</label>
          <input type="file" id="compare-image" name="image" accept="image/*" {% if not (active_tab == 'model-comparison' and uploaded_filename) %}required{% endif %}>
          {% if active_tab == 'model-comparison' and uploaded_filename %}
          <input type="hidden" name="previous_file" value="{{ uploaded_basename }}">
          <input type="hidden" name="previous_filename" value="{{ uploaded_filename }}">
          <p class="hint" style="color: #4ade80; margin-top: 4px;">‚úì Current file: {{ uploaded_filename }}</p>
          <p class="hint">This image will be processed by all 4 models simultaneously</p>
          {% else %}
          <p class="hint">This image will be processed by all 4 models simultaneously</p>
          {% endif %}
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button type="submit" style="flex: 1;">üîç Compare All Models</button>
          <button type="button" onclick="clearForm('comparison-form')" class="btn-clear" style="flex: 0 0 auto;">üóëÔ∏è Clear</button>
        </div>
      </form>
    </div>

    {% if comparison_results %}
    <div class="card">
      <h2>Comparison Results</h2>
      
      <div style="margin-bottom: 30px;">
        <h3>Original Image</h3>
        <img src="{{ comparison_results.original_url }}" alt="Original" style="max-width: 400px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      </div>

      <h3>Model Outputs</h3>
      <div class="comparison-grid">
        {% for result in comparison_results.models %}
        <div class="card" style="margin: 0;">
          <h3 style="margin-top: 0;">{{ result.model_name }}</h3>
              <div class="comparison-image-container"
                  data-model-index="{{ loop.index0 }}"
                  style="position: relative; display: inline-block; width: 100%;">
                <img
                  class="comparison-detection-image"
                  data-model-index="{{ loop.index0 }}"
                  src="{{ result.result_url }}"
                  alt="{{ result.model_name }}"
                  style="width: 100%; border-radius: 8px; display: block;"
                >
                <div
                  class="comparison-bbox-layer"
                  data-model-index="{{ loop.index0 }}"
                  style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; border-radius: 8px;"
                ></div>
              </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
            <div class="stat-box">
              <div class="stat-label">Objects</div>
              <div class="stat-value" style="font-size: 20px;">{{ result.detection_count }}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Confidence</div>
              <div class="stat-value" style="font-size: 20px;">{{ '%.1f%%' | format(result.avg_confidence * 100) }}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Time (ms)</div>
              <div class="stat-value" style="font-size: 20px;">{{ result.inference_time }}</div>
            </div>
          </div>

            <details style="margin-top: 15px;">
              <summary style="cursor: pointer; font-weight: 600; color: #667eea;">View Detections</summary>

              {# capture the outer loop index in a variable #}
              {% set model_index = loop.index0 %}

              <table
                class="detection-table comparison-detections-table"
                style="margin-top: 10px; font-size: 13px;"
                data-model-index="{{ model_index }}"
              >
                <thead>
                  <tr>
                    <th>Object</th>
                    <th>Confidence</th>
                    <th>Freshness</th>  {# NEW COLUMN #}
                  </tr>
                </thead>
                <tbody>
                  {% for det in result.detections %}
                  <tr
                    class="comparison-detection-row"
                    data-model-index="{{ model_index }}"
                    data-det-index="{{ loop.index0 }}"
                    onclick="highlightComparisonDetection({{ model_index }}, {{ loop.index0 }})"
                  >
                    <td>{{ det.label|capitalize }}</td>
                    <td>{{ '%.2f%%' | format(det.score * 100) }}</td>
                    <td>
                      {{ det.freshness|default('Unknown')|capitalize }}
                      {% if det.freshness_score is defined %}
                        ({{ '%.1f%%' | format(det.freshness_score * 100) }})
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </details>
          </div>
        {% endfor %}
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3>Comparison Summary</h3>
        <table class="metrics-table">
          <thead>
            <tr>
              <th>Model</th>
              <th>Detections</th>
              <th>Avg Confidence</th>
              <th>Inference Time</th>
            </tr>
          </thead>
          <tbody>
            {% for result in comparison_results.models %}
            <tr>
              <td><strong>{{ result.model_name }}</strong></td>
              <td>{{ result.detection_count }}</td>
              <td>{{ '%.2f%%' | format(result.avg_confidence * 100) }}</td>
              <td>{{ result.inference_time }}ms</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Tab 3: Performance Metrics -->
  <div id="performance-metrics" class="tab-content">
    <div class="card">
      <h2>Model Performance Metrics</h2>
      <p style="color: #e0e0e0; margin-bottom: 20px;">
        Comprehensive evaluation metrics for all detection models on the fruit dataset.
      </p>

      <table class="metrics-table">
        <thead>
          <tr>
            <th>Model</th>
            <th>mAP@0.5</th>
            <th>mAP@0.5:0.95</th>
            <th>Precision</th>
            <th>Recall</th>
            <th>Params (M)</th>
            <th>Avg Inference (ms)</th>
          </tr>
        </thead>
        <tbody>
          {% for model_key, metrics in performance_metrics.items() %}
          <tr>
            <td><strong>{{ metrics.name }}</strong></td>
            <td class="{% if metrics.map_50 == performance_metrics.values()|map(attribute='map_50')|max %}best-metric{% endif %}">
              {{ '%.3f' | format(metrics.map_50) }}
              {% if metrics.map_50 == performance_metrics.values()|map(attribute='map_50')|max %}
              <span class="metric-badge badge-success">Best</span>
              {% endif %}
            </td>
            <td class="{% if metrics.map_50_95 == performance_metrics.values()|map(attribute='map_50_95')|max %}best-metric{% endif %}">
              {{ '%.3f' | format(metrics.map_50_95) }}
              {% if metrics.map_50_95 == performance_metrics.values()|map(attribute='map_50_95')|max %}
              <span class="metric-badge badge-success">Best</span>
              {% endif %}
            </td>
            <td class="{% if metrics.precision == performance_metrics.values()|map(attribute='precision')|max %}best-metric{% endif %}">
              {{ '%.3f' | format(metrics.precision) }}
              {% if metrics.precision == performance_metrics.values()|map(attribute='precision')|max %}
              <span class="metric-badge badge-success">Best</span>
              {% endif %}
            </td>
            <td class="{% if metrics.recall == performance_metrics.values()|map(attribute='recall')|max %}best-metric{% endif %}">
              {{ '%.3f' | format(metrics.recall) }}
              {% if metrics.recall == performance_metrics.values()|map(attribute='recall')|max %}
              <span class="metric-badge badge-success">Best</span>
              {% endif %}
            </td>
            <td>{{ '%.1f' | format(metrics.params) }}</td>
            <td class="{% if metrics.inference_time == performance_metrics.values()|map(attribute='inference_time')|min %}best-metric{% endif %}">
              {{ metrics.inference_time }}
              {% if metrics.inference_time == performance_metrics.values()|map(attribute='inference_time')|min %}
              <span class="metric-badge badge-success">Fastest</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div style="margin-top: 30px; padding: 20px; background: #252540; border-radius: 8px; border-left: 4px solid #667eea;">
        <h3 style="margin-top: 0;">Key Insights</h3>
        <ul style="margin: 10px 0; padding-left: 20px; color: #e0e0e0;">
          <li><strong>Faster R-CNN</strong> provides highest accuracy (mAP) with precise bounding boxes</li>
          <li><strong>YOLO11 Large</strong> offers state-of-the-art performance with good speed-accuracy tradeoff</li>
          <li><strong>YOLOv8 Nano</strong> is the fastest model, ideal for real-time applications</li>
          <li><strong>YOLOv8 Medium</strong> balances speed and accuracy for most use cases</li>
        </ul>
      </div>
    </div>
  </div>

  <footer>
    <p>Fruit Detection System ¬∑ Advanced Computer Vision Project ¬∑ 2025</p>
  </footer>
</div>

<!-- ================== Charts (Plotly) ================== -->
<script>
  // Activate the correct tab on page load
  document.addEventListener('DOMContentLoaded', function() {
    const activeTab = '{{ active_tab }}';
    if (activeTab && activeTab !== 'live-detection') {
      // Hide all tabs
      const tabContents = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
      }
      
      // Remove active from all buttons
      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }
      
      // Activate the correct tab
      document.getElementById(activeTab).classList.add('active');
      
      // Activate the correct button
      const buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(btn => {
        if (btn.onclick && btn.onclick.toString().includes(activeTab)) {
          btn.classList.add('active');
        }
      });
    }
  });
  
  function switchTab(evt, tabName) {
    // Hide all tab contents
    const tabContents = document.getElementsByClassName('tab-content');
    for (let i = 0; i < tabContents.length; i++) {
      tabContents[i].classList.remove('active');
    }
    
    // Remove active class from all buttons
    const tabButtons = document.getElementsByClassName('tab-button');
    for (let i = 0; i < tabButtons.length; i++) {
      tabButtons[i].classList.remove('active');
    }
    
    // Show current tab and mark button as active
    document.getElementById(tabName).classList.add('active');
    evt.currentTarget.classList.add('active');
  }
  
  function clearForm(formId) {
    const form = document.getElementById(formId);
    if (form) {
      // Only reset the select dropdown to first option
      const selectInput = form.querySelector('select');
      if (selectInput) {
        selectInput.selectedIndex = 0;
      }
    }
  }
  
  // Live video functionality
  let videoActive = false;
  
  async function startVideo() {
    const modelSelect = document.getElementById('video-model');
    const selectedModel = modelSelect.value;
    
    // Set the model on the backend
    try {
      const response = await fetch('/set_video_model', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ model: selectedModel })
      });
      
      const data = await response.json();
      if (!data.success) {
        alert('Failed to set model');
        return;
      }
    } catch (error) {
      console.error('Error setting model:', error);
      alert('Failed to connect to server');
      return;
    }
    
    // Show video container and hide placeholder
    document.getElementById('video-container').style.display = 'block';
    document.getElementById('video-placeholder').style.display = 'none';
    
    // Set video stream source
    const videoStream = document.getElementById('video-stream');
    videoStream.src = '/video_feed?' + new Date().getTime();
    
    // Update button states
    document.getElementById('start-video-btn').disabled = true;
    document.getElementById('start-video-btn').style.opacity = '0.5';
    document.getElementById('stop-video-btn').disabled = false;
    document.getElementById('stop-video-btn').style.opacity = '1';
    document.getElementById('video-model').disabled = true;
    
    videoActive = true;
  }
  
  function stopVideo() {
    // Stop video stream
    const videoStream = document.getElementById('video-stream');
    videoStream.src = '';
    
    // Hide video container and show placeholder
    document.getElementById('video-container').style.display = 'none';
    document.getElementById('video-placeholder').style.display = 'block';
    
    // Update button states
    document.getElementById('start-video-btn').disabled = false;
    document.getElementById('start-video-btn').style.opacity = '1';
    document.getElementById('stop-video-btn').disabled = true;
    document.getElementById('stop-video-btn').style.opacity = '0.5';
    document.getElementById('video-model').disabled = false;
    
    videoActive = false;
  }

  // ==========================
  // Live Detection: row ‚Üí box
  // ==========================

  // Build a JS array of bounding boxes from Jinja
  // Each box is [x1, y1, x2, y2] in original image coordinates
  const liveDetections = [
    {% if live_result and live_result.detections %}
      {% for det in live_result.detections %}
        [{{ det.box[0]|int }}, {{ det.box[1]|int }}, {{ det.box[2]|int }}, {{ det.box[3]|int }}]{% if not loop.last %},{% endif %}
      {% endfor %}
    {% endif %}
  ];

  function highlightLiveDetection(index) {
    const img = document.getElementById('live-detection-image');
    const overlay = document.getElementById('live-bbox-layer');

    if (!img || !overlay) return;
    if (!liveDetections || !liveDetections[index]) return;

    // Get displayed size vs original size
    const rect = img.getBoundingClientRect();
    const displayedWidth = rect.width;
    const displayedHeight = rect.height;

    const naturalWidth = img.naturalWidth || displayedWidth;
    const naturalHeight = img.naturalHeight || displayedHeight;

    const scaleX = displayedWidth / naturalWidth;
    const scaleY = displayedHeight / naturalHeight;

    const box = liveDetections[index];
    const x1 = box[0] * scaleX;
    const y1 = box[1] * scaleY;
    const x2 = box[2] * scaleX;
    const y2 = box[3] * scaleY;

    const w = x2 - x1;
    const h = y2 - y1;

    // Clear previous highlight(s)
    overlay.innerHTML = '';

    // Draw new highlight box
    const boxDiv = document.createElement('div');
    boxDiv.style.position = 'absolute';
    boxDiv.style.left = x1 + 'px';
    boxDiv.style.top = y1 + 'px';
    boxDiv.style.width = w + 'px';
    boxDiv.style.height = h + 'px';
    boxDiv.style.border = '3px solid #ffcc00';
    boxDiv.style.boxSizing = 'border-box';
    boxDiv.style.pointerEvents = 'none';
    boxDiv.style.borderRadius = '6px';
    boxDiv.style.boxShadow = '0 0 10px rgba(255, 204, 0, 0.7)';
    overlay.appendChild(boxDiv);

    // Visually highlight the selected table row
    const rows = document.querySelectorAll('#live-detections-table tbody tr');
    rows.forEach((row, i) => {
      if (i === index) {
        row.classList.add('selected-detection-row');
      } else {
        row.classList.remove('selected-detection-row');
      }
    });
  }

    // ==============================
  // Model Comparison: row ‚Üí box
  // ==============================

  // 2D array of bounding boxes:
  // comparisonDetections[modelIndex][detIndex] = [x1, y1, x2, y2]
  const comparisonDetections = [
    {% if comparison_results and comparison_results.models %}
      {% for result in comparison_results.models %}
        [
          {% for det in result.detections %}
            [{{ det.box[0]|int }}, {{ det.box[1]|int }}, {{ det.box[2]|int }}, {{ det.box[3]|int }}]{% if not loop.last %},{% endif %}
          {% endfor %}
        ]{% if not loop.last %},{% endif %}
      {% endfor %}
    {% else %}
      []
    {% endif %}
  ];

  function highlightComparisonDetection(modelIndex, detIndex) {
    if (!comparisonDetections[modelIndex] || !comparisonDetections[modelIndex][detIndex]) {
      return;
    }

    // Find image & overlay for this model
    const img = document.querySelector(
      '.comparison-detection-image[data-model-index="' + modelIndex + '"]'
    );
    const overlay = document.querySelector(
      '.comparison-bbox-layer[data-model-index="' + modelIndex + '"]'
    );

    if (!img || !overlay) return;

    const rect = img.getBoundingClientRect();
    const displayedWidth = rect.width;
    const displayedHeight = rect.height;

    const naturalWidth = img.naturalWidth || displayedWidth;
    const naturalHeight = img.naturalHeight || displayedHeight;

    const scaleX = displayedWidth / naturalWidth;
    const scaleY = displayedHeight / naturalHeight;

    const box = comparisonDetections[modelIndex][detIndex];
    const x1 = box[0] * scaleX;
    const y1 = box[1] * scaleY;
    const x2 = box[2] * scaleX;
    const y2 = box[3] * scaleY;

    const w = x2 - x1;
    const h = y2 - y1;

    // Clear previous box for this model
    overlay.innerHTML = '';

    const boxDiv = document.createElement('div');
    boxDiv.style.position = 'absolute';
    boxDiv.style.left = x1 + 'px';
    boxDiv.style.top = y1 + 'px';
    boxDiv.style.width = w + 'px';
    boxDiv.style.height = h + 'px';
    boxDiv.style.border = '3px solid #ffcc00';
    boxDiv.style.boxSizing = 'border-box';
    boxDiv.style.pointerEvents = 'none';
    boxDiv.style.borderRadius = '6px';
    boxDiv.style.boxShadow = '0 0 10px rgba(255, 204, 0, 0.7)';
    overlay.appendChild(boxDiv);

    // Highlight the selected row for this model
    const rows = document.querySelectorAll(
      '.comparison-detection-row[data-model-index="' + modelIndex + '"]'
    );
    rows.forEach((row, i) => {
      if (i === detIndex) {
        row.classList.add('selected-detection-row');
      } else {
        row.classList.remove('selected-detection-row');
      }
    });
  }
</script>
</body>
</html>
